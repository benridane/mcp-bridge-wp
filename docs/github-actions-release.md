# GitHub Actions Release Process

このドキュメントでは、MCP Bridge プラグインのGitHub Actionsを使用したリリースプロセスについて説明します。

## 概要

3つのワークフローファイルが設定されています：

1. **`.github/workflows/release.yml`** - リリース時の自動ビルドとZIPファイル作成
2. **`.github/workflows/create-release.yml`** - 手動でのリリース作成
3. **`.github/workflows/qa.yml`** - 品質保証とテスト

## リリース方法

### 方法1: GitHubのUIから手動でリリースを作成

1. GitHubリポジトリの「Releases」ページに移動
2. 「Draft a new release」をクリック
3. タグ（例：`v1.2.3`）を入力
4. リリースタイトルと説明を入力
5. 「Publish release」をクリック

→ 自動的に`release.yml`ワークフローが実行され、プラグインZIPファイルが作成されます。

### 方法2: GitHub Actionsから手動でリリースを作成

1. GitHubリポジトリの「Actions」タブに移動
2. 「Create Release」ワークフローを選択
3. 「Run workflow」をクリック
4. 以下の情報を入力：
   - **Version**: セマンティックバージョニング（例：1.2.3）
   - **Pre-release**: プレリリースの場合はチェック
   - **Draft**: ドラフトとして作成する場合はチェック
5. 「Run workflow」をクリック

→ リリースが作成され、その後`release.yml`ワークフローが自動実行されます。

## 自動化されるプロセス

### リリース時（release.yml）

1. **環境準備**
   - PHP 8.1環境のセットアップ
   - Composerの準備

2. **バージョン更新**
   - タグからバージョン番号を抽出
   - `mcp-bridge.php`のバージョン情報を自動更新

3. **ビルドプロセス**
   - 本番用Composer依存関係のインストール
   - 開発用ファイルの除去：
     - `reference-code/`
     - `logs/`, `.git/`, `.github/`
     - `composer.json`, `package.json`
     - `tests/`, `phpunit.xml`
     - その他の開発用ファイル

4. **パッケージ作成**
   - プラグインZIPファイルの作成（`mcp-bridge-vX.Y.Z.zip`）
   - バージョン情報ファイルの作成
   - ファイル一覧情報の作成

5. **リリースアセットのアップロード**
   - プラグインZIPファイル
   - バージョン情報ファイル
   - ファイル一覧情報

### 品質保証（qa.yml）

プッシュやプルリクエスト時に以下をチェック：

1. **PHPリントとコードスタイル**
   - PHP構文エラーのチェック
   - コーディング標準のチェック（設定されている場合）

2. **セキュリティスキャン**
   - Trivyを使用した脆弱性スキャン
   - セキュリティレポートをGitHub Security tabにアップロード

3. **プラグイン構造検証**
   - 必須ファイルの存在確認
   - プラグインヘッダーの確認
   - バージョン情報の一貫性チェック

4. **互換性チェック**
   - PHP 7.4, 8.0, 8.1, 8.2での構文チェック

5. **ビルドテスト**
   - リリースビルドプロセスのテスト
   - ZIPファイル作成のテスト

## ベストプラクティス

### リリース前の準備

1. **バージョン番号の決定**
   - セマンティックバージョニングに従う
   - 破壊的変更：メジャーバージョンアップ
   - 新機能：マイナーバージョンアップ
   - バグフィックス：パッチバージョンアップ

2. **変更ログの準備**
   - 主要な変更点をまとめる
   - ユーザーへの影響を説明する

3. **テストの実行**
   - QAワークフローが正常に通ることを確認
   - 手動でのテストも実施

### リリース後の確認

1. **リリースページの確認**
   - ZIPファイルがアップロードされていることを確認
   - バージョン情報が正しいことを確認

2. **ダウンロードテスト**
   - ZIPファイルをダウンロードして解凍
   - WordPressサイトでのインストールテスト

## トラブルシューティング

### よくある問題

1. **ワークフローが実行されない**
   - リポジトリの「Actions」が有効になっているか確認
   - 権限設定を確認（Settings > Actions > General）

2. **ビルドエラー**
   - ログを確認してエラーの原因を特定
   - 必要に応じてワークフローファイルを修正

3. **ZIPファイルが作成されない**
   - ビルドプロセスのログを確認
   - ファイル構造が正しいか確認

### デバッグ方法

1. **ワークフローログの確認**
   - Actions tabでワークフローの実行ログを確認
   - 各ステップの詳細を確認

2. **ローカルでのテスト**
   - `tools/create-release.sh`スクリプトでローカルテスト
   - ビルドプロセスを手動で実行

## 手動リリース作成（緊急時）

GitHub Actionsが利用できない場合：

```bash
# ローカルでのリリース作成
cd /path/to/mcp-bridge
./tools/create-release.sh

# 作成されたZIPファイルを手動でGitHubにアップロード
```

## セキュリティ

- リリースワークフローでは本番用依存関係のみをインストール
- 開発用ファイルは自動的に除去
- セキュリティスキャンが自動実行される
- アクセス権限は最小限に設定

## 今後の拡張

- WordPress.org プラグインディレクトリへの自動アップロード
- より詳細なテストの追加
- 複数のWordPressバージョンでのテスト
- 自動的なドキュメント生成